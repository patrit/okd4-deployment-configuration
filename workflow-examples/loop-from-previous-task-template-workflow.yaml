apiVersion: argoproj.io/v1alpha1
kind: WorkflowTemplate
metadata:
  name: loop-from-previous-task-template
spec:
  entrypoint: loop-from-previous-task
  templates:

  - name: loop-from-previous-task
    inputs:
      parameters:
      - name: number
        value: 12
    steps:
    - - name: generate
        template: gen-dict-list
        arguments:
          parameters:
          - name: number
            value: "{{inputs.parameters.number}}"
    # Iterate over the list of numbers generated by the generate step above
    - - name: sleep
        template: mysleep
        arguments:
          parameters:
          - name: index
            value: "{{item.idx}}"
          - name: value
            value: "{{item.val}}"
        withParam: "{{steps.generate.outputs.result}}" # parameter specifies the list to iterate over

  - name: gen-dict-list
    inputs:
      parameters:
      - name: number
    script:
      image: python:alpine3.6
      command: [python]
      source: |
        import random, json, sys
        json.dump([{"val": random.randint(3, 30), "idx": idx} for idx, x in enumerate(range({{inputs.parameters.number}}))], sys.stdout)

  - name: mysleep
    inputs:
      parameters:
      - name: index
      - name: value
    container:
      image: alpine:latest
      command: [sh, -c]
      args: ["sleep {{inputs.parameters.value}}; echo index={{inputs.parameters.index}}"]
